<html>
<head>
<!-- Copyright Olli Etuaho 2013-2019 -->
<meta charset="UTF-8">
<title>glbrush.js example application</title>
<script type="module">

import { Rect } from './src/math/rect.js';

import { Vec2 } from './src/math/vec2.js';

import { BlendingMode } from './src/util/blending_mode.js'

import { PictureUpdate } from './src/picture_update.js'

import { Picture } from './src/picture.js';

import { PictureRenderer } from './src/picture_renderer.js';

/**
 * Utility function to get event coordinates relative to an element.
 */
function getRelativeCoords(event, element) {
    var rect = element.getBoundingClientRect();
    // + 0.5 to move to pixel center
    if (event.touches !== undefined && event.touches.length > 0) {
        return new Vec2(event.touches[0].clientX - rect.left + 0.5,
                        event.touches[0].clientY - rect.top + 0.5);
    }
    return new Vec2(event.clientX - rect.left + 0.5,
                    event.clientY - rect.top + 0.5);
}

var loadApp = function() {
    // Create a container element for the picture
    var drawArea = document.createElement('div');
    var width = 800;
    var height = 600;
    drawArea.style.width = width + 'px';
    drawArea.style.height = height + 'px';
    document.body.appendChild(drawArea);

    // Initialize a Picture with one opaque layer and add it to the drawArea
    var picture = new Picture(0, null, new Rect(0, width, 0, height), 1.0,
                              PictureRenderer.create(['webgl', 'no-float-webgl', 'canvas']));
    picture.addBuffer(0, [255, 255, 255, 255], false);
    picture.setCurrentEventAttachment(0);
    drawArea.appendChild(picture.pictureElement());
    picture.display();

    // Add mouse event listeners to the container element that create brush
    // events on the draw area
    var currentEvent = null;
    var pressureInd = 0;
    drawArea.onmousedown = function(e) {
        var coords = getRelativeCoords(e, drawArea);
        var oldPixel = picture.getPixelRGBA(coords);
        // some funky color changes
        var red = 255 - oldPixel[0];
        var green = 33;
        var blue = 42;
        currentEvent = picture.createBrushEvent([red, green, blue], 0.8, 1.0,
                                                20, 0, 1,
                                                BlendingMode.normal, 0);
    };
    drawArea.onmouseup = function(e) {
        if (currentEvent !== null) {
            picture.setCurrentEvent(null);
            var update = new PictureUpdate('add_picture_event');
            update.setPictureEvent(currentEvent);
            picture.pushUpdate(update);
            picture.display();
            currentEvent = null;
        }
    };
    drawArea.onmouseout = drawArea.onmouseup;
    drawArea.onmousemove = function(e) {
        if (currentEvent !== null) {
            ++pressureInd;
            var pressure = (Math.sin(pressureInd * 0.4) + 2.0) * 0.33;
            var coords = getRelativeCoords(e, drawArea);
            picture.pictureTransform.inverseTransform(coords);
            currentEvent.pushCoordTriplet(coords.x, coords.y, pressure);
            picture.setCurrentEvent(currentEvent);
            picture.display();
        }
    };
    
    var createButton = function(value, onclick) {
        var btn = document.createElement('input');
        btn.type = 'button';
        btn.value = value;
        document.body.appendChild(btn);
        btn.onclick = onclick;
    };

    // Add undo to the mix just for kicks
    createButton('Undo', function() {
        var undone = picture.undoLatest();
        if (undone) {
            var update = new PictureUpdate('undo');
            update.setUndoEvent(undone.sid, undone.sessionEventId);
            picture.pushUpdate(update, false);
        }
        picture.display();
    });

    // And animation!
    createButton('Animate', function() {
        picture.animate(0.15);
    });

    // Whee, resize
    var resize = function(scale) {
        if (!picture.animating) {
            picture.crop(picture.boundsRect, scale);
            drawArea.style.width = picture.bitmapWidth();
            drawArea.style.height = picture.bitmapHeight();
            picture.display();
        }
    };
    createButton('0.5x', function() {
        resize(0.5);
    });
    createButton('1.0x', function() {
        resize(1.0);
    });
    if (picture.maxBitmapScale() > 1.5) {
        createButton('1.5x', function() {
            resize(1.5);
        });
    }

    // And there's a lot more public API in Picture to use...
}

loadApp();
</script>
</head>
<body style="background:#888;">
</body>
</html>